import os
import oracledb
from mcp.server.fastmcp import FastMCP

mcp = FastMCP("Oracle Database Server")

def get_connection():
    return oracledb.connect(
        user=os.getenv("ORACLE_USER"),
        password=os.getenv("ORACLE_PASSWORD"),
        dsn=os.getenv("ORACLE_DSN")
    )

@mcp.tool()
def query_data(sql: str) -> str:
    """Execute SELECT query and return results in table format"""
    with get_connection() as conn:
        with conn.cursor() as cursor:
            cursor.execute(sql)
            columns = [desc[0] for desc in cursor.description]
            rows = cursor.fetchall()
            
            if not rows:
                return "No results"
            
            col_widths = [max(len(str(col)), max(len(str(row[i])) for row in rows)) for i, col in enumerate(columns)]
            
            header = " | ".join(col.ljust(w) for col, w in zip(columns, col_widths))
            separator = "-+-".join("-" * w for w in col_widths)
            data_rows = "\n".join(" | ".join(str(val).ljust(w) for val, w in zip(row, col_widths)) for row in rows)
            
            return f"{header}\n{separator}\n{data_rows}"

@mcp.tool()
def insert_data(table: str, columns: str, values: str) -> str:
    """Insert data into table. columns: 'col1,col2', values: 'val1,val2'"""
    sql = f"INSERT INTO {table} ({columns}) VALUES ({values})"
    with get_connection() as conn:
        with conn.cursor() as cursor:
            cursor.execute(sql)
            conn.commit()
            return f"Inserted {cursor.rowcount} row(s)"

@mcp.tool()
def update_data(table: str, set_clause: str, where_clause: str = "") -> str:
    """Update data. set_clause: 'col1=val1,col2=val2', where_clause: 'id=1'"""
    sql = f"UPDATE {table} SET {set_clause}"
    if where_clause:
        sql += f" WHERE {where_clause}"
    with get_connection() as conn:
        with conn.cursor() as cursor:
            cursor.execute(sql)
            conn.commit()
            return f"Updated {cursor.rowcount} row(s)"

@mcp.tool()
def delete_data(table: str, where_clause: str = "") -> str:
    """Delete data from table. where_clause: 'id=1'"""
    sql = f"DELETE FROM {table}"
    if where_clause:
        sql += f" WHERE {where_clause}"
    with get_connection() as conn:
        with conn.cursor() as cursor:
            cursor.execute(sql)
            conn.commit()
            return f"Deleted {cursor.rowcount} row(s)"

@mcp.tool()
def inspect_table(table_name: str) -> str:
    """Get table structure and metadata"""
    sql = f"""
    SELECT column_name, data_type, data_length, nullable, data_default
    FROM user_tab_columns
    WHERE table_name = UPPER('{table_name}')
    ORDER BY column_id
    """
    with get_connection() as conn:
        with conn.cursor() as cursor:
            cursor.execute(sql)
            columns = [desc[0] for desc in cursor.description]
            rows = cursor.fetchall()
            
            if not rows:
                return f"Table {table_name} not found"
            
            result = f"Table: {table_name}\n\n"
            for row in rows:
                result += f"{row[0]}: {row[1]}({row[2]}) {'NULL' if row[3] == 'Y' else 'NOT NULL'}"
                if row[4]:
                    result += f" DEFAULT {row[4]}"
                result += "\n"
            return result

@mcp.tool()
def inspect_package(package_name: str) -> str:
    """Get package procedures and functions"""
    sql = f"""
    SELECT object_name, procedure_name, object_type
    FROM user_procedures
    WHERE object_name = UPPER('{package_name}')
    ORDER BY procedure_name
    """
    with get_connection() as conn:
        with conn.cursor() as cursor:
            cursor.execute(sql)
            rows = cursor.fetchall()
            
            if not rows:
                return f"Package {package_name} not found"
            
            result = f"Package: {package_name}\n\n"
            for row in rows:
                proc_name = row[1] if row[1] else "(package body)"
                result += f"- {proc_name}\n"
            return result

@mcp.tool()
def inspect_procedure(procedure_name: str) -> str:
    """Get procedure/function parameters"""
    sql = f"""
    SELECT argument_name, data_type, in_out, position
    FROM user_arguments
    WHERE object_name = UPPER('{procedure_name}')
    ORDER BY position
    """
    with get_connection() as conn:
        with conn.cursor() as cursor:
            cursor.execute(sql)
            rows = cursor.fetchall()
            
            if not rows:
                return f"Procedure {procedure_name} not found"
            
            result = f"Procedure: {procedure_name}\n\n"
            for row in rows:
                arg_name = row[0] if row[0] else "RETURN"
                result += f"{arg_name}: {row[1]} ({row[2]})\n"
            return result

if __name__ == "__main__":
    mcp.run()
